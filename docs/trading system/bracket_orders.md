# Bracket Orders: TP/SL Management

## Overview

As of the bracket order implementation, the trading system sends **bracket orders** to IBKR that include:
1. **Entry order** (MARKET or LIMIT)
2. **Take-profit order** (LIMIT at target price)
3. **Stop-loss order** (STOP at stop price)

The TP and SL orders are linked to the entry order via IBKR's parent-child order mechanism and only activate after the entry fills. When either TP or SL fills, IBKR automatically cancels the other (One-Cancels-Other behavior).

## Benefits

- **Robustness**: TP/SL are enforced by IBKR even if your process crashes or restarts
- **Scalability**: Each position is independently managed by IBKR
- **Simplicity**: Less state to track in your application
- **Reliability**: No dependency on bar-checking loops or process uptime

## Implementation Details

### Order Submission Flow

When a `TradePlan` is generated by the strategy:

1. `submit_trade_plan_bracket()` converts the plan to a `BracketOrderRequest`
2. `IBKRBrokerTws.place_bracket_order()` submits three orders:
   - Entry order with `transmit=False`
   - TP order with `transmit=False`, `parentId=entry.orderId`
   - SL order with `transmit=True`, `parentId=entry.orderId`
3. Setting `transmit=True` only on the last order sends all three atomically

### Order Types

- **Entry**: MARKET order (can be LIMIT if needed)
- **Take-Profit**: LIMIT order at `plan.tp_price`
- **Stop-Loss**: STOP order with `auxPrice=plan.sl_price`

For long positions:
- Entry: BUY
- TP/SL: SELL (opposite side)

For short positions:
- Entry: SELL
- TP/SL: BUY (opposite side)

### Logging

Bracket order submissions log all three order IDs:
```python
{
  "type": "order_submitted",
  "entry_order_id": "123",
  "tp_order_id": "124",
  "sl_order_id": "125",
  ...
}
```

## Position Reconciliation

### On Startup/Reconnect

The live session calls `broker.get_positions()` and `broker.get_open_orders()` to reconcile:

1. **Existing positions**: If IBKR shows positions, check for associated TP/SL orders
2. **Missing brackets**: If a position exists without TP/SL orders, log a warning
3. **Manual intervention**: Existing positions should be closed manually or have brackets added via TWS

### Automatic Bracket Checking

The system **automatically checks** if all positions have complete bracket orders:

**When checks occur:**
- After initial connection (`after_subscribe`)
- After each bar (if `snapshot_every_n_bars` configured)
- After reconnection (`after_reconnect`)
- After order submission (`after_order_submit`)

**What is checked:**
- Each position must have at least one TP order (LIMIT, opposite side)
- Each position must have at least one SL order (STOP, opposite side)
- Orders on the same side as the position (entry orders) are ignored

**When warnings are generated:**
```python
{
  "type": "position_missing_brackets",
  "symbol": "NVDA",
  "quantity": 10.0,
  "has_tp": True,
  "has_sl": False,
  "tp_orders_count": 1,
  "sl_orders_count": 0
}
```

**Console output:**
```
[live] WARNING: Position in NVDA (qty=10.0) lacks complete brackets: 
has_tp=True, has_sl=False (tp_orders=1, sl_orders=0)
```

### No Automatic Bracket Addition

The system **does not** automatically create TP/SL orders for existing positions. This is intentional:
- Prevents unintended order duplication
- Avoids conflicts with manually placed orders
- Keeps behavior predictable and explicit

If you restart with open positions that lack brackets, the system will:
- Detect the position via `has_open_position = True`
- Prevent opening new positions (respecting the single-position gate)
- **Log warnings** about missing brackets (every snapshot)
- **Not** attempt to add brackets automatically

**Recommended action:** Close positions without brackets manually via TWS or add brackets using TWS's bracket order feature

## Multiple Positions (Future)

When the single-position gate is removed:

### Independent Management
- Each bracket is self-contained and tracked by IBKR
- Positions close FIFO: oldest entry's bracket closes first
- No complex state reconciliation needed in your code

### Per-Symbol Tracking
```python
# Future: track per symbol instead of global boolean
position_state = {
    "NVDA": {"has_position": True, "bracket_ids": [...]},
    "TSLA": {"has_position": True, "bracket_ids": [...]}
}
```

## Testing

### Unit Tests
- `tests/test_execution_bracket.py`: Conversion logic
- `tests/test_ibkr_broker_tws.py`: Mock IBKR interactions (to be added)

### Manual Testing Checklist

Before using with real (even paper) accounts:

1. **Bracket submission**:
   - Submit bracket order to paper account
   - Verify all three orders appear in TWS
   - Verify parent-child linking (orderId references)

2. **Entry fill**:
   - Let entry fill
   - Verify TP/SL orders activate (status changes to Submitted)

3. **TP hit**:
   - Simulate price reaching TP
   - Verify position closes
   - Verify SL order is cancelled

4. **SL hit**:
   - Simulate price hitting SL
   - Verify position closes
   - Verify TP order is cancelled

5. **Reconnect test**:
   - Submit bracket and let entry fill
   - Stop and restart the live session
   - Verify positions and orders reconcile correctly
   - Verify no duplicate brackets are created

## Rollback Procedure

If bracket orders fail in production:

1. **Immediate**: Enable kill switch (`touch ui_state/live/KILL_SWITCH`)
2. **Close positions**: Manually close positions via TWS
3. **Revert code**: Switch back to simple `submit_trade_plan()` (entry only)
4. **Investigate**: Check JSONL logs for error details
5. **Fix**: Address the issue, test in paper account again

## Known Limitations

- **No dynamic adjustment**: Once submitted, TP/SL cannot be adjusted based on new predictions
- **DAY orders only**: All orders are DAY time-in-force (not GTC)
- **No partial closes**: Bracket is all-or-nothing for the full position size
- **Account linking**: Multi-account setups require explicit account configuration

## Future Enhancements

- **Trailing stops**: Adjust SL as price moves in favorable direction
- **Partial position management**: Close portions of positions with separate brackets
- **GTC support**: Keep positions open overnight with GTC orders
- **Bracket adjustment**: Modify TP/SL based on new predictions (requires cancelling and resubmitting)
